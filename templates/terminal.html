<!DOCTYPE html>
<html>
<head>
    <title>üåë THE ORB v7.0 ‚Äî Sistem Manajemen Keamanan Jaringan</title>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.9/dist/vis-network.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.9/styles/vis-network.min.css" rel="stylesheet" type="text/css" />
    <style>
        body { background: #f0f2f5; color: #333; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; }
        .container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; max-width: 1600px; margin: 0 auto; }
        .panel { border: 1px solid #e0e0e0; border-radius: 8px; background: white; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .header { background: #1a3a6c; color: white; padding: 15px 20px; border-radius: 8px 8px 0 0; margin: -20px -20px 20px -20px; }
        .log { height: 200px; overflow-y: auto; font-size: 0.9em; margin: 10px 0; background: #f8f9fa; border-radius: 4px; padding: 10px; }
        .btn { background: #1a3a6c; color: white; border: none; padding: 10px 15px; cursor: pointer; width: 100%; margin: 5px 0; border-radius: 4px; font-weight: 500; transition: background 0.3s; }
        .btn:hover { background: #254d8c; }
        .btn.secondary { background: #6c757d; }
        .btn.secondary:hover { background: #8a9399; }
        .btn.danger { background: #dc3545; }
        .btn.danger:hover { background: #c82333; }
        input, select { background: #f8f9fa; color: #333; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; width: 100%; margin-bottom: 12px; }
        .tab { display: none; }
        .tab.active { display: block; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #e9ecef; font-weight: 600; }
        td, th { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        tr:hover { background-color: #f8f9fa; }
        .agent-row:hover { background: #f0f5ff; }
        .severity-low { background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; }
        .severity-medium { background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; }
        .severity-high { background: #f8d7da; color: #721c24; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; }
        .stats-card { text-align: center; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .stats-value { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .stats-label { color: #6c757d; font-size: 14px; }
        .low { background: #e8f5e9; }
        .medium { background: #fffde7; }
        .high { background: #ffebee; }
        .network-graph { height: 350px; background: #f8f9fa; border-radius: 4px; }
        .user-info { float: right; background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 20px; }
        .notification-badge { background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.7em; position: absolute; top: 5px; right: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåë THE ORB v7.0 ‚Äî Sistem Manajemen Keamanan Jaringan</h1>
        <div class="user-info">
            <span id="username">Admin</span> 
            <button onclick="logout()" class="btn secondary" style="padding: 3px 10px; margin: 0; font-size: 0.9em;">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- ‚öôÔ∏è Control Panel -->
        <div class="panel">
            <h2>‚öôÔ∏è Kontrol Agent</h2>
            <button onclick="refreshAgents()" class="btn">üîÑ Refresh Agents</button>
            <select id="agentSelect" class="form-control">
                <option value="">Memuat...</option>
            </select>
            <input type="text" id="targetInput" placeholder="Target (IP/Domain)" />
            
            <h3 style="margin: 15px 0 10px 0;">Pemindaian Jaringan</h3>
            <button class="btn" onclick="sendCommand('ping')">üì° Ping</button>
            <button class="btn" onclick="sendCommand('scan')">üîç Scan Port</button>
            
            <h3 style="margin: 15px 0 10px 0;">Manajemen Keamanan</h3>
            <div style="display: flex; gap: 5px;">
                <button class="btn" onclick="sendCommand('block_ip')">üõ°Ô∏è Blokir IP</button>
                <button class="btn secondary" onclick="sendCommand('unblock_ip')">üîì Buka Blokir</button>
            </div>
            
            <div class="stats-card high" style="margin-top: 20px;">
                <div class="stats-value" id="high-severity-count">0</div>
                <div class="stats-label">Ancaman Tinggi</div>
            </div>
            <div class="stats-card medium">
                <div class="stats-value" id="medium-severity-count">0</div>
                <div class="stats-label">Ancaman Sedang</div>
            </div>
            <div class="stats-card low">
                <div class="stats-value" id="low-severity-count">0</div>
                <div class="stats-label">Peringatan</div>
            </div>
        </div>

        <!-- üåê Network Graph -->
        <div class="panel">
            <h2>üåê Peta Jaringan</h2>
            <div id="network" class="network-graph"></div>
        </div>

        <!-- üìã Agent List -->
        <div class="panel">
            <h2>üìã Agent Terdaftar</h2>
            <table id="agentsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>IP</th>
                        <th>OS</th>
                        <th>Status</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data akan diisi oleh JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- üì¢ Realtime Log -->
        <div class="panel">
            <h2>üì¢ Log Realtime</h2>
            <div id="logs" class="log"></div>
        </div>

        <!-- üìä Security Events -->
        <div class="panel">
            <h2>üìä Event Keamanan</h2>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn secondary" onclick="loadSecurityEvents(null)">Semua</button>
                <button class="btn" onclick="loadSecurityEvents(false)">Belum Selesai</button>
                <button class="btn secondary" onclick="loadSecurityEvents(true)">Selesai</button>
            </div>
            <div id="securityEvents" style="max-height: 300px; overflow-y: auto;">
                <!-- Event akan diisi oleh JavaScript -->
            </div>
        </div>

        <!-- üìà Daily Report -->
        <div class="panel">
            <h2>üìà Laporan Harian</h2>
            <div id="dailyReport">
                <p>Mengambil laporan terbaru...</p>
            </div>
            <button class="btn" onclick="generateReport()" style="margin-top: 15px;">Buat Laporan Baru</button>
        </div>
    </div>

    <script>
        const logs = document.getElementById("logs");
        const agentSelect = document.getElementById("agentSelect");
        const agentsTable = document.getElementById("agentsTable").querySelector("tbody");
        const BASE_URL = window.location.origin;
        const WS_URL = window.location.protocol === "https:" ? `wss://${window.location.host}/ws` : `ws://${window.location.host}/ws`;

        // Tambahkan log dengan format yang konsisten
        function addLog(text, type = "info") {
            const p = document.createElement("p");
            let icon = "‚ÑπÔ∏è";
            let color = "#333";
            
            if (type === "info") {
                icon = "‚ÑπÔ∏è";
                color = "#1a3a6c";
            } else if (type === "warning") {
                icon = "‚ö†Ô∏è";
                color = "#ffc107";
            } else if (type === "error") {
                icon = "‚ùå";
                color = "#dc3545";
            } else if (type === "success") {
                icon = "‚úÖ";
                color = "#28a745";
            }
            
            p.innerHTML = `<span style="color: ${color}">${icon}</span> ${text}`;
            logs.appendChild(p);
            logs.scrollTop = logs.scrollHeight;
        }

        // Inisialisasi WebSocket
        let ws;
        function connectWebSocket() {
            try {
                ws = new WebSocket(WS_URL);
                ws.onopen = () => addLog("Terhubung ke sistem THE ORB", "success");
                
                ws.onmessage = (e) => {
                    try {
                        const data = JSON.parse(e.data);
                        handleWebSocketMessage(data);
                    } catch (err) {
                        console.error("Error parsing message:", err);
                    }
                };
                
                ws.onerror = (e) => addLog("Error koneksi WebSocket", "error");
                ws.onclose = () => {
                    addLog("Koneksi terputus, mencoba menyambung kembali...", "warning");
                    setTimeout(connectWebSocket, 3000);
                };
            } catch (err) {
                addLog(`Gagal menghubungkan ke ${WS_URL}: ${err.message}`, "error");
                setTimeout(connectWebSocket, 5000);
            }
        }

        function handleWebSocketMessage(data) {
            if (data.type === "ai_alert") {
                const severityClass = data.data.severity === "high" ? "severity-high" : 
                                    data.data.severity === "medium" ? "severity-medium" : "severity-low";
                
                addLog(
                    `<span class="${severityClass}">${data.data.severity.toUpperCase()}</span> ${data.data.message}`,
                    data.data.severity === "high" ? "error" : 
                    data.data.severity === "medium" ? "warning" : "info"
                );
            } else if (data.type === "command") {
                addLog(
                    `Perintah <strong>${data.data.command}</strong> dikirim ke agent ${data.data.agent_id.substring(0,8)} oleh ${data.data.executed_by}`,
                    "info"
                );
            } else if (data.type === "security_event") {
                updateSecurityEvent(data.data);
            }
        }

        // Refresh daftar agent
        async function refreshAgents() {
            try {
                const res = await fetch(`${BASE_URL}/api/agents`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const data = await res.json();
                if (!data.agents || data.agents.length === 0) {
                    agentSelect.innerHTML = '<option value="">(Tidak ada agent)</option>';
                    addLog("Tidak ada agent aktif", "info");
                    return;
                }

                // Update dropdown
                let options = '<option value="">Pilih Agent</option>';
                data.agents.forEach(a => {
                    const idShort = a.agent_id.substring(0, 8);
                    const selAttr = a.agent_id === agentSelect.value ? "selected" : "";
                    options += `<option value="${a.agent_id}" ${selAttr}>${idShort} (${a.ip})</option>`;
                });
                agentSelect.innerHTML = options;

                // Update tabel
                agentsTable.innerHTML = '';
                data.agents.forEach(a => {
                    const row = document.createElement('tr');
                    row.className = 'agent-row';
                    row.innerHTML = `
                        <td title="${a.agent_id}">${a.agent_id.substring(0,8)}...</td>
                        <td>${a.ip}</td>
                        <td>${a.os_info || 'Unknown'}</td>
                        <td><span class="severity-low">Aktif</span></td>
                        <td>${a.last_seen}</td>
                    `;
                    agentsTable.appendChild(row);
                });

                addLog(`Ditemukan ${data.agents.length} agent aktif`, "success");
            } catch (err) {
                addLog(`Gagal memuat agent: ${err.message}`, "error");
            }
        }

        // Kirim perintah ke agent
        async function sendCommand(command) {
            const agent = agentSelect.value;
            const target = document.getElementById("targetInput").value;
            if (!agent) {
                addLog("Pilih agent terlebih dahulu", "warning");
                return;
            }

            try {
                const res = await fetch(`${BASE_URL}/api/command`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ 
                        agent_id: agent, 
                        command: command,
                        target: target 
                    })
                });

                if (res.ok) {
                    addLog(`Perintah "${command}" dikirim ke ${agent.substring(0,8)}`, "success");
                } else {
                    const error = await res.json();
                    addLog(`Gagal mengirim perintah: ${error.message || 'Unknown error'}`, "error");
                }
            } catch (err) {
                addLog(`Kesalahan jaringan: ${err.message}`, "error");
            }
        }

        // Update peta jaringan
        function updateNetwork() {
            fetch(`${BASE_URL}/api/agents`)
                .then(r => r.json())
                .then(data => {
                    const nodes = [{id: "core", label: "CORE", color: "#1a3a6c", size: 25}];
                    const edges = [];
                    
                    // Tambahkan agent ke peta
                    data.agents.forEach(a => {
                        nodes.push({
                            id: a.agent_id, 
                            label: a.agent_id.slice(0,6), 
                            color: "#28a745",
                            size: 15
                        });
                        edges.push({from: "core", to: a.agent_id});
                    });

                    const container = document.getElementById("network");
                    const dataVis = { 
                        nodes: new vis.DataSet(nodes), 
                        edges: new vis.DataSet(edges) 
                    };
                    
                    const options = {
                        physics: {
                            enabled: true,
                            stabilization: { iterations: 25 }
                        },
                        edges: {
                            color: {
                                color: "#6c757d",
                                highlight: "#1a3a6c"
                            }
                        },
                        nodes: {
                            font: {
                                color: '#333',
                                size: 14
                            }
                        }
                    };
                    
                    new vis.Network(container, dataVis, options);
                })
                .catch(err => console.error("Gagal update peta jaringan:", err));
        }

        // Muat event keamanan
        async function loadSecurityEvents(resolved) {
            try {
                let url = `${BASE_URL}/api/security/events`;
                if (resolved !== null) {
                    url += `?resolved=${resolved}`;
                }
                
                const res = await fetch(url, {
                    headers: {
                        "Authorization": `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const data = await res.json();
                const container = document.getElementById("securityEvents");
                container.innerHTML = '';
                
                if (data.events.length === 0) {
                    container.innerHTML = '<p>Tidak ada event keamanan yang sesuai kriteria.</p>';
                    return;
                }
                
                data.events.forEach(event => {
                    const eventEl = document.createElement('div');
                    eventEl.className = 'panel' + (event.resolved ? ' resolved' : '');
                    eventEl.style.marginBottom = '10px';
                    eventEl.style.padding = '10px';
                    eventEl.style.borderLeft = '4px solid ' + 
                        (event.severity === 'high' ? '#dc3545' : 
                         event.severity === 'medium' ? '#ffc107' : '#28a745');
                    
                    const severityClass = event.severity === 'high' ? 'severity-high' : 
                                        event.severity === 'medium' ? 'severity-medium' : 'severity-low';
                    
                    eventEl.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="${severityClass}">${event.severity.toUpperCase()}</span>
                            <small>${new Date(event.timestamp).toLocaleString()}</small>
                        </div>
                        <h4 style="margin: 8px 0;">${event.event_type.replace('_', ' ')}</h4>
                        <p style="margin: 5px 0; color: #555;">${event.description}</p>
                        ${event.resolved ? 
                            `<div style="background: #e9ecef; padding: 5px; border-radius: 4px; margin-top: 5px;">
                                <strong>Resolved:</strong> ${event.resolution_notes || 'No notes'}
                            </div>` : 
                            `<button class="btn" onclick="resolveEvent(${event.id})" 
                                    style="padding: 5px 10px; font-size: 0.9em; margin-top: 8px;">
                                Tandai Selesai
                            </button>`
                        }
                    `;
                    container.appendChild(eventEl);
                });
            } catch (err) {
                addLog(`Gagal memuat event keamanan: ${err.message}`, "error");
            }
        }

        // Tandai event sebagai selesai
        async function resolveEvent(eventId) {
            const notes = prompt("Masukkan catatan resolusi:");
            if (!notes) return;
            
            try {
                const res = await fetch(`${BASE_URL}/api/security/events/${eventId}/resolve`, {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ resolution_notes: notes })
                });
                
                if (res.ok) {
                    addLog(`Event keamanan ${eventId} ditandai sebagai selesai`, "success");
                    loadSecurityEvents(false); // Refresh daftar event yang belum selesai
                } else {
                    addLog("Gagal menandai event sebagai selesai", "error");
                }
            } catch (err) {
                addLog(`Kesalahan jaringan: ${err.message}`, "error");
            }
        }

        // Update tampilan event keamanan
        function updateSecurityEvent(event) {
            // Update jumlah ancaman di statistik
            if (event.severity === 'high') {
                document.getElementById('high-severity-count').textContent = 
                    parseInt(document.getElementById('high-severity-count').textContent) + 1;
            } else if (event.severity === 'medium') {
                document.getElementById('medium-severity-count').textContent = 
                    parseInt(document.getElementById('medium-severity-count').textContent) + 1;
            } else {
                document.getElementById('low-severity-count').textContent = 
                    parseInt(document.getElementById('low-severity-count').textContent) + 1;
            }
            
            // Tambahkan ke daftar event jika sedang ditampilkan
            const container = document.getElementById("securityEvents");
            if (container && container.children.length < 10) {
                const eventEl = document.createElement('div');
                eventEl.className = 'panel';
                eventEl.style.marginBottom = '10px';
                eventEl.style.padding = '10px';
                eventEl.style.borderLeft = '4px solid ' + 
                    (event.severity === 'high' ? '#dc3545' : 
                     event.severity === 'medium' ? '#ffc107' : '#28a745');
                
                const severityClass = event.severity === 'high' ? 'severity-high' : 
                                    event.severity === 'medium' ? 'severity-medium' : 'severity-low';
                
                eventEl.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="${severityClass}">${event.severity.toUpperCase()}</span>
                        <small>${new Date(event.timestamp).toLocaleString()}</small>
                    </div>
                    <h4 style="margin: 8px 0;">${event.type.replace('_', ' ')}</h4>
                    <p style="margin: 5px 0; color: #555;">${event.description}</p>
                `;
                
                container.insertBefore(eventEl, container.firstChild);
            }
        }

        // Hasilkan laporan harian
        async function generateReport() {
            try {
                const res = await fetch(`${BASE_URL}/api/daily-report`, {
                    headers: {
                        "Authorization": `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const report = await res.json();
                const reportDiv = document.getElementById("dailyReport");
                
                reportDiv.innerHTML = `
                    <h3>Laporan Harian: ${report.date}</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                        <tr style="background: #e9ecef;">
                            <td style="padding: 8px;">Event Tinggi</td>
                            <td style="padding: 8px; text-align: right; font-weight: bold;">${report.summary.high_severity_events}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">Event Sedang</td>
                            <td style="padding: 8px; text-align: right; font-weight: bold;">${report.summary.medium_severity_events}</td>
                        </tr>
                        <tr style="background: #e9ecef;">
                            <td style="padding: 8px;">Event Rendah</td>
                            <td style="padding: 8px; text-align: right; font-weight: bold;">${report.summary.low_severity_events}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px;">Agent Aktif</td>
                            <td style="padding: 8px; text-align: right; font-weight: bold;">${report.summary.active_agents}</td>
                        </tr>
                        <tr style="background: #e9ecef;">
                            <td style="padding: 8px;">Masalah Belum Selesai</td>
                            <td style="padding: 8px; text-align: right; font-weight: bold;">${report.summary.unresolved_issues}</td>
                        </tr>
                    </table>
                    <button class="btn" onclick="downloadReport()">Unduh Laporan</button>
                `;
            } catch (err) {
                addLog(`Gagal menghasilkan laporan: ${err.message}`, "error");
            }
        }

        // Unduh laporan
        function downloadReport() {
            const reportDiv = document.getElementById("dailyReport");
            const date = new Date().toISOString().split('T')[0];
            
            // Buat konten laporan
            const content = `
                THE ORB v7.0 - Laporan Keamanan Jaringan
                Tanggal: ${date}
                ======================================
                
                Ringkasan:
                - Event Tinggi: ${document.querySelector('[class*="high"] .stats-value').textContent}
                - Event Sedang: ${document.querySelector('[class*="medium"] .stats-value').textContent}
                - Event Rendah: ${document.querySelector('[class*="low"] .stats-value').textContent}
                - Agent Aktif: ${document.querySelectorAll('.agent-row').length}
                - Masalah Belum Selesai: ${document.querySelectorAll('.panel:not(.resolved)').length}
                
                Detail Event Terbaru:
                ${Array.from(document.querySelectorAll('#securityEvents > div')).slice(0, 5).map(el => {
                    const title = el.querySelector('h4').textContent;
                    const desc = el.querySelector('p').textContent;
                    const severity = el.querySelector('span').textContent;
                    return `- [${severity}] ${title}: ${desc}`;
                }).join('\n')}
                
                Laporan ini dihasilkan oleh THE ORB v7.0 - Sistem Manajemen Keamanan Jaringan
            `;
            
            // Buat file dan unduh
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `the-orb-report-${date}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Fungsi autentikasi
        async function login() {
            const username = document.getElementById('username-input').value;
            const password = document.getElementById('password-input').value;
            
            try {
                const response = await fetch(`${BASE_URL}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'username': username,
                        'password': password
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Username atau password salah');
                }
                
                const data = await response.json();
                localStorage.setItem('token', data.access_token);
                showMainInterface();
                addLog('Login berhasil', 'success');
            } catch (error) {
                addLog(`Login gagal: ${error.message}`, 'error');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Inisialisasi
        function init() {
            connectWebSocket();
            refreshAgents();
            updateNetwork();
            loadSecurityEvents(false);
            generateReport();
            
            // Auto-refresh
            setInterval(refreshAgents, 30000);
            setInterval(updateNetwork, 60000);
            setInterval(() => loadSecurityEvents(false), 30000);
        }

        // Jalankan saat halaman siap
        document.addEventListener('DOMContentLoaded', () => {
            // Pastikan ada token
            if (!localStorage.getItem('token')) {
                window.location.href = '/login';
                return;
            }
            
            // Tampilkan nama pengguna
            const username = localStorage.getItem('username') || 'Admin';
            document.getElementById('username').textContent = username;
            
            init();
        });
    </script>
</body>
</html>